<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Pricing Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .preview {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .preview h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .cost-display {
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
        }
        .help-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>ðŸ’° Staff Pricing Calculator</h1>
        
        <form id="pricingForm">
            <input type="hidden" id="jobId" name="jobId" value="">
            
            <div class="form-group">
                <label for="jobComplexity">Job Complexity:</label>
                <select id="jobComplexity" name="jobComplexity" required>
                    <option value="">Select complexity...</option>
                    <option value="simple">Simple (1.0x base rate)</option>
                    <option value="medium">Medium (1.2x base rate)</option>
                    <option value="complex">Complex (1.8x base rate)</option>
                </select>
                <div class="help-text">How technically challenging is this job?</div>
            </div>

            <div class="form-group">
                <label for="urgency">Urgency Level:</label>
                <select id="urgency" name="urgency" required>
                    <option value="">Select urgency...</option>
                    <option value="standard">Standard (No surcharge)</option>
                    <option value="urgent">Urgent (Priority scheduling)</option>
                    <option value="emergency">Emergency (+50% surcharge)</option>
                </select>
                <div class="help-text">How quickly does this need to be completed?</div>
            </div>

            <div class="form-group">
                <label for="timeOfDay">Time of Day:</label>
                <select id="timeOfDay" name="timeOfDay" required>
                    <option value="">Select time...</option>
                    <option value="business_hours">Business Hours (8AM-6PM)</option>
                    <option value="after_hours">After Hours (+40% surcharge)</option>
                </select>
                <div class="help-text">When will the work be performed?</div>
            </div>

            <div class="form-group">
                <label for="dayType">Day Type:</label>
                <select id="dayType" name="dayType" required>
                    <option value="">Select day type...</option>
                    <option value="weekday">Weekday (Mon-Fri)</option>
                    <option value="weekend">Weekend (+30% surcharge)</option>
                </select>
                <div class="help-text">What type of day is the work scheduled?</div>
            </div>

            <div class="form-group">
                <label for="estimatedHours">Estimated Hours:</label>
                <input type="number" id="estimatedHours" name="estimatedHours" 
                       min="0.5" max="24" step="0.5" value="2" required>
                <div class="help-text">How many hours do you expect this job to take?</div>
            </div>

            <div class="preview" id="preview">
                <h3>Cost Preview:</h3>
                <div class="cost-display" id="costDisplay">$0.00</div>
                <div id="breakdown"></div>
            </div>

            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="previewCost()">
                    Preview Cost
                </button>
                <button type="submit" class="btn-primary">
                    Apply Pricing to Job
                </button>
            </div>
        </form>
    </div>

    <script>
        // Get job ID from URL parameters or ServiceM8 context
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job_id') || urlParams.get('jobId');
        if (jobId) {
            document.getElementById('jobId').value = jobId;
        }

        // Pricing rules (matching server-side)
        const PRICING_RULES = {
            jobTypes: {
                'plumbing': { baseRate: 120, multiplier: 1.0 },
                'electrical': { baseRate: 150, multiplier: 1.2 },
                'hvac': { baseRate: 130, multiplier: 1.1 },
                'general': { baseRate: 100, multiplier: 1.0 }
            },
            factors: {
                emergency: 1.5,
                weekend: 1.3,
                afterHours: 1.4,
                complexity: {
                    simple: 1.0,
                    medium: 1.2,
                    complex: 1.8
                }
            },
            staffLevels: {
                trainee: 0.8,
                junior: 1.0,
                senior: 1.3,
                expert: 1.6
            }
        };

        function previewCost() {
            const formData = new FormData(document.getElementById('pricingForm'));
            const answers = Object.fromEntries(formData.entries());
            
            // Calculate preview cost (simplified client-side calculation)
            const baseConfig = PRICING_RULES.jobTypes.general; // Default to general
            let totalCost = baseConfig.baseRate * baseConfig.multiplier;
            
            // Apply factors
            if (answers.urgency === 'emergency') {
                totalCost *= PRICING_RULES.factors.emergency;
            }
            if (answers.dayType === 'weekend') {
                totalCost *= PRICING_RULES.factors.weekend;
            }
            if (answers.timeOfDay === 'after_hours') {
                totalCost *= PRICING_RULES.factors.afterHours;
            }
            if (answers.jobComplexity) {
                totalCost *= PRICING_RULES.factors.complexity[answers.jobComplexity];
            }
            
            const estimatedHours = parseFloat(answers.estimatedHours) || 1;
            totalCost *= estimatedHours;
            
            // Round to nearest dollar
            totalCost = Math.round(totalCost * 100) / 100;
            
            // Display preview
            document.getElementById('costDisplay').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('breakdown').innerHTML = `
                <small>
                    Base: $${baseConfig.baseRate}/hr Ã— ${estimatedHours}hrs<br>
                    Factors: ${answers.jobComplexity}, ${answers.urgency}, ${answers.timeOfDay}, ${answers.dayType}
                </small>
            `;
            document.getElementById('preview').style.display = 'block';
        }

        // Handle form submission
        document.getElementById('pricingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/calculate-cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jobId: data.jobId,
                        answers: data
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Pricing applied successfully!\nTotal Cost: $${result.calculation.totalCost}\nJob updated with pricing details.`);
                    // Close modal or redirect back to ServiceM8
                    if (window.parent && window.parent.postMessage) {
                        window.parent.postMessage({
                            type: 'addon_complete',
                            success: true,
                            data: result
                        }, '*');
                    }
                } else {
                    alert('Error applying pricing: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Auto-preview when values change
        document.querySelectorAll('select, input').forEach(element => {
            element.addEventListener('change', function() {
                if (document.getElementById('preview').style.display === 'block') {
                    previewCost();
                }
            });
        });
    </script>
</body>
</html>
